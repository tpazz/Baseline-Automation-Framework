#!/usr/bin/env bash
set -euo pipefail

###############################################################################
#  Resolve paths
###############################################################################
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" &>/dev/null && pwd)"

# ---------- Java -------------------------------------------------------------
export JAVA_HOME="$SCRIPT_DIR/src/test/resources/jdks/linux"
export PATH="$JAVA_HOME/bin:$PATH"

# ---------- Gradle -----------------------------------------------------------
# Use the job‑scoped temp dir: exec‑capable on Microsoft‑hosted runners
export GRADLE_USER_HOME="${AGENT_TEMPDIRECTORY:-${RUNNER_TEMP:-/var/tmp}}/gradle"
mkdir -p "$GRADLE_USER_HOME"

###############################################################################
#  Debug
###############################################################################
echo "JAVA_HOME         = $JAVA_HOME"
echo "GRADLE_USER_HOME  = $GRADLE_USER_HOME"
java -version

###############################################################################
#  Make wrapper executable
###############################################################################
chmod +x "$SCRIPT_DIR/gradlew"

###############################################################################
#  (Optional) chmod driver binaries if they already exist
###############################################################################
for f in \
  "$SCRIPT_DIR/src/test/resources/webdriver/linux/chromedriver-linux64/chromedriver" \
  "$SCRIPT_DIR/src/test/resources/webdriver/linux/edgedriver-linux64/msedgedriver" \
  "$SCRIPT_DIR/src/test/resources/webdriver/linux/geckodriver-linux64/geckodriver"
do
  [[ -f "$f" ]] && chmod +x "$f" || echo "INFO  $f not present – skipping chmod"
done

###############################################################################
#  Run Gradle
###############################################################################
exec "$SCRIPT_DIR/gradlew" "$@"
